<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½¿ç”¨ Tesseract.js è¯†åˆ«å’Œåˆ†æ®µæ–‡æœ¬</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        #preview {
            display: none;
            margin-top: 20px;
            max-width: 300px;
        }
        .paragraph {
            margin: 10px 0;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<h1>OCR å°å·¥å…·</h1>

<input type="file" id="fileInput" accept="image/*" capture="camera">
<button id="processButton">è¯†åˆ«æ–‡æœ¬</button>
<div id="outputText"></div>
<img id="preview" alt="é¢„è§ˆå›¾" />

<script>
    document.getElementById('fileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];

        if (file) {
            document.getElementById('outputText').innerHTML = "";
            const reader = new FileReader();

            reader.onload = function(e) {
                const preview = document.getElementById('preview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };

            reader.readAsDataURL(file);
        }
    });

    document.getElementById('processButton').addEventListener('click', async () => {
        const fileInput = document.getElementById('fileInput');
        const outputText = document.getElementById('outputText');

        if (fileInput.files.length === 0) {
            outputText.textContent = "è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡.";
            return;
        }

        const file = fileInput.files[0];

        outputText.innerHTML = "è¯†åˆ«ä¸­ï¼Œè¯·ç¨å€™...";

        try {
            const result = await Tesseract.recognize(file, 'chi_sim');

            const paragraphs = result.data.text
                .split(/\n/)
                .filter(Boolean)
                .map(line => line.replace(/\s+/g, ""))

            fetch('<%= serverUrl %>/analyse', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(paragraphs)
            })
                .then(response => response.json())
                .then(data => {
                    outputText.innerHTML = "";

                    if (data.length === 0) {
                        outputText.innerHTML = "<h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç­”æ¡ˆ ğŸ˜­</h3>";
                        return
                    }

                    let innerHtml = "<h3>åŒ¹é…åˆ°å•¦~~~ ğŸ¥³</h3>";

                    innerHtml += data.map((result, index) => `
                        <h4>é—®é¢˜ ${index + 1}ï¼š</h4>
                        <div class="paragraph">${result.question}</div>
                        <h4>ç­”æ¡ˆï¼š</h4>
                        ${result.answers.map(answer => `<div class="paragraph">${answer}</div>`).join("")} `
                    ).join("")

                    outputText.innerHTML = innerHtml;
                })
                .catch((error) => {
                    outputText.innerHTML = "è¯†åˆ«å‡ºé”™â€¦â€¦" + error;
                });
        } catch (error) {
            console.error(error);
            outputText.textContent = "è¯†åˆ«è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯.";
        }
    });
</script>
</body>
</html>
